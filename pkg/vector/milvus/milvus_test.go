package milvus

import (
	"context"
	"testing"

	"github.com/stretchr/testify/assert"
)

var (
	milvusClient   *MilvusClient
	exampleVector  = []float32{0.014838364, -0.017620698, 0.039551493, 0.015700748, -0.0011719975, -0.013021858, -0.010251275, 0.012758525, 0.019684473, -0.03831288, 0.001341002, 0.064250916, -0.002414946, 0.013822225, -0.0031436041, 0.019625148, -0.01564217, -0.0052712923, -0.015714055, -0.030302437, -0.023091216, -0.009670714, 0.015752068, -0.0038696309, -0.0043562334, -0.008719393, 0.0027820505, 0.02187728, 0.020052845, -0.0077083246, -0.0087030055, -0.008234454, 0.0040822765, -0.015165803, 0.00357362, 0.015885333, 0.023709305, -0.014285445, -0.018217837, -0.0178895, -0.036025092, 0.00083955115, 0.014567554, 0.005873727, 0.013601852, 0.013569581, -0.13623272, -0.01620436, -0.016131273, -0.036731627, 0.021327132, 0.00086528336, 0.027448554, 0.06727927, 0.014286099, 0.013202444, -0.02393746, 0.0235503, 0.019170485, 0.021919766, 0.03503096, -0.019138088, -0.006739168, 0.027075253, -0.033817433, 0.036604814, -0.010031421, -0.016051564, 0.0076677925, -0.009989969, 0.009421281, 0.0050558955, -0.013369248, -0.013520031, -0.021161506, 0.0032631315, -0.002559837, -0.008193062, 0.03864989, -0.0041056178, 0.011382851, 0.0043259826, 0.044303134, 0.0062390473, -0.007576711, 0.0070692142, 0.011444597, 0.002004812, 0.011841655, 0.03266881, -0.0440562, -0.019674443, 0.049414042, 0.03268112, 0.006078411, -0.017142553, 0.020702785, 0.007652628, 0.020619985, 0.009974223, 0.007835002, 0.04429414, -0.0064316993, -0.052523065, -0.029133398, -0.0146194985, -0.014619836, 0.009158691, 0.008382959, -0.10954855, -0.019274492, 0.030559044, -0.02578594, 0.018183038, -0.03630349, 0.028039437, -0.0031390805, 0.0137243755, 0.030133571, 0.0005093897, 0.008661845, 0.05171257, 0.033242453, 0.013949195, 0.020825248, 0.030746315, 0.014621836, -0.0046388065, -0.030364914, 0.01363981, 0.013196568, 0.030295568, -0.0174938, -0.020367127, 0.027555155, -0.018687103, 0.051717162, 0.023337685, 0.0068090595, 0.031118283, -0.04470329, -0.03815111, -0.16577286, -0.009473712, 0.0012697432, -0.035571016, 0.015115573, -0.019996492, -0.03263, 0.011677124, 0.01732706, -0.00072131, -0.032654494, 0.019310793, 0.005825045, 0.0024686672, 0.016264752, -0.0080637615, 0.0099125365, 0.02263525, -0.023083536, 0.012654782, -0.0019935432, 0.0013407182, 0.033267837, -0.01659477, -0.0017987847, -0.0115283, 0.037528917, 0.00034592906, -0.026666755, -0.017653765, -0.011911211, -0.044888854, 0.010300219, 0.017710255, 0.06358, 0.018672366, -0.021409824, -0.023174927, -0.024199752, -0.0200502, -0.005743808, -0.005195007, -0.011057331, -0.01153751, 0.006358018, 0.020102525, 0.0036482087, 0.012744272, -0.010941555, 0.03139748, 0.040872224, -0.023371434, 0.04934634, -0.032586604, -0.029276755, 0.040274605, 0.012786386, 0.029377582, 0.009591064, 0.00343692, 0.015113719, -0.0059439307, 0.012573738, 0.15877238, -0.011829165, 0.0047420408, -0.0033891946, 0.0073359436, 0.01082526, -0.011793815, -0.016057836, 0.020213237, 0.028924668, -0.0030009332, -0.03922341, -0.008591165, 0.0137856705, -0.008285535, 0.023076719, -0.0039982805, -0.0146758715, -0.022576937, -0.015657607, 0.024632135, 0.03174942, 0.010056781, 0.0027731599, -0.06140183, -0.01037124, 0.0016801344, -0.038836733, 0.028363021, 0.02272064, -0.0031611838, 0.0038485106, -0.021977214, 0.02571117, -0.044925276, 0.0065538604, -0.038620915, 0.032227237, 0.04337141, -0.004964503, 0.03319142, -0.0025206713, 0.03564532, -0.03317853, -0.016576312, -0.010151547, -0.019243194, 0.01859985, -0.011652391, 0.011788655, -0.008821268, -0.013966298, -0.029581772, 0.0011792006, 0.022502907, 0.023570362, 0.011041806, 0.0054137483, 0.01136796, 0.025268491, -0.025972445, -0.033805266, -0.04554501, 0.04532494, 0.019158257, -0.005576231, 0.031196062, -0.015332367, -0.22690581, -0.018452574, 0.0028970218, 0.028916495, 0.036128055, 0.02234652, 0.035011537, 0.011490907, 0.0154022435, 0.034814894, 0.016039088, -0.033290755, 0.009284299, 0.0345211, -0.041654, 0.013161275, 0.00090003444, -0.0066361027, 0.014908384, -0.0007631966, 0.012913064, 0.0036558479, 0.0005156213, -0.0070527974, -0.004504945, 0.0029339797, 0.010207012, -0.007562483, 0.029348409, -0.048445627, -0.00320237, -0.014569097, -0.04028096, -0.016391898, 0.02919993, -0.47404745, -0.013345222, -0.022310713, -0.026250625, -0.01452949, -0.011486279, -0.0032556157, 0.019542836, 0.0001164813, -0.006093245, -0.0014315548, 0.019292241, 0.002716208, 0.009988825, -0.028337467, -0.001480295, -0.010886474, 0.01840926, 0.006160934, -0.00936346, -0.03437453, -0.024849296, -0.0020006124, -0.013547301, -0.017221741, 0.004963671, -0.0058589587, 0.010824432, 0.002591003, 0.010618487, 0.004222109, -0.003241194, 0.016680053, 0.013110307, 0.014485241, 0.0044939877, 0.026941715, 0.00865972, 0.03758676, 0.0072575766, -0.014026135, 0.059755262, 0.0049331742, 0.024177276, 0.040791262, 0.034922283, 0.0017641912, 0.0076271654, -0.035317704, 0.02381471, -0.01385649, -0.007852505, 0.041393764, -0.0050646984, 0.011507972, 0.012655169, -0.0076508056, -0.019883038, 0.017577171, -0.0002979984, 0.0031304385, -0.008362382, 0.020301871, -0.019696226, 0.040463403, -0.0005293077, 0.009099654, -0.019911662, 0.048317768, 0.035024546, -0.017664244, 0.0019191966, 0.002901581, -0.08070902, 0.00021889158, 0.021420196, -0.034751747, -0.019428387, 0.03938823, -0.024003804, -0.0046148803, -0.016937349, 0.032183547, 0.00402007, 0.028713647, -0.017370513, 0.019817289, -0.02342447, 0.0068543674, 0.00024666477, -0.00006084482, -0.039199762, -0.018024683, -0.03164163, 0.051410977, 0.048208483, -0.0119695775, -0.026077947, 0.029647399, 0.0028355687, 0.034863584, -0.016725319, -0.0038504696, -0.0031427776, -0.028767373, -0.01213128, 0.002139904, 0.01762601, 0.006600361, -0.053048335, -0.020808456, 0.011661664, -0.036584266, -0.0020801786, 0.06361078, -0.0135586, -0.023307404, 0.0067742546, 0.0036768273, 0.008805854, -0.014147713, 0.024371535, 0.011926635, -0.022567747, -0.0012365249, 0.0087882625, -0.028221928, 0.0022280738, 0.0034959784, 0.02975402, 0.0108348485, 0.011475353, 0.032121204, -0.050673988, -0.0026767442, -0.04551726, -0.029637087, 0.011718687, -0.006415919, -0.003757314, -0.020736735, 0.016643772, 0.025524274, 0.03153301, 0.04350964, -0.0036638333, 0.022227088, -0.022370365, -0.03546318, 0.016464086, 0.02993969, -0.028887564, 0.061588686, 0.0039404524, -0.021679886, 0.0015329276, 0.03013087, -0.022506868, -0.018775234, -0.014957843, 0.0119680045, -0.017912662, -0.08536765, 0.011492664, 0.025277797, 0.028616965, -0.014308099, -0.056252003, 0.005479866, -0.0048354478, -0.029662022, -0.0073950156, -0.021931097, -0.006393613, 0.010457335, 0.016776003, -0.022647167, -0.016725188, 0.007636527, -0.037838165, 0.017805288, 0.016914202, -0.028953755, 0.0027893241, 0.020019934, -0.027045246, -0.0063255937, -0.04483596, 0.00076982466, 0.018942785, 0.031327553, 0.008128298, 0.020161482, -0.021124803, -0.024175653, -0.013439824, -0.00020664975, 0.047930967, 0.002983051, -0.0064846002, 0.0014040401, 0.010465845, -0.036296282, 0.004096728, 0.045669038, -0.034743734, 0.054350525, 0.0024032863, -0.02436844, 0.0021644612, -0.0015580772, -0.030310983, -0.02116161, 0.004089734, 0.012532454, -0.011866499, -0.008149107, -0.015987147, -0.014838581, -0.014042834, 0.03950637, -0.0081894165, -0.011330618, -0.0044439165, -0.017552774, 0.0055255364, 0.047746133, -0.0180145, -0.006038069, 0.026872234, -0.0022477505, 0.013040733, 0.023238622, -0.0010938424, 0.003337597, -0.013552453, -0.014337369, -0.0017943259, -0.00930265, 0.034664348, 0.019636748, 0.018359799, -0.012646118, -0.03573063, -0.023170844, 0.022474239, -0.009263427, -0.008184437, -0.02938159, 0.014352807, 0.010041592, -0.023655923, -0.012420379, -0.039050147, 0.044157572, -0.003995087, 0.00902031, 0.0054842355, -0.0033872214, -0.011662388, -0.037438367, 0.013023613, -0.014543291, -0.0072621885, -0.005672118, 0.03369685, -0.0027222203, -0.014462151, -0.008329522, 0.009433829, 0.0136858905, -0.024328247, 0.006465071, 0.020336792, -0.008821166, -0.0065075024, -0.04063474, 0.008280466, -0.0015778339, -0.0023045647, 0.11269022, 0.015746169, -0.024842395, 0.00055270403, 0.009698641, -0.000575511, 0.024415608, -0.019155748, 0.021760643, 0.0069623054, 0.032219592, -0.0020632427, 0.020025678, -0.0007373515, 0.017476436, 0.053086706, 0.022838505, -0.0139748575, 0.024216855, -0.038033184, 0.026937954, 0.043613244, 0.03662654, -0.027365856, 0.008198622, -0.012873694, 0.010881722, -0.0040878137, -0.038802564, -0.0040000193, 0.067471705, 0.032404773, -0.018721236, 0.060300224, -0.011354774, 0.021440435, 0.045396443, -0.016600858, -0.010134071, -0.002838615, 0.027490908, 0.028651439, 0.025606519, -0.008494687, -0.017257677, 0.013411966, 0.0051182695, 0.013201371, 0.010941291, -0.012172995, 0.042408634, 0.011018278, -0.014006068, 0.048964094, -0.025562942, -0.022584576, 0.049159188, -0.037635382, -0.032043677, 0.013482845, 0.06878712, 0.038469125, 0.0030257653, 0.0033526968, 0.0066778027, 0.031604078, 0.019530509, 0.030301707, -0.007821905, -0.010145646, 0.011003401, -0.028458841, 0.0051495847, -0.026235644, -0.0008209383, -0.029649906, 0.009109153, -0.03184981, -0.0041207597, -0.20402302, 0.0051892903, 0.010797182, 0.02067622, 0.018927343, 0.009714799, -0.006196521, -0.011524141, 0.0023700763, 0.012265317, -0.036812942, -0.009687532, 0.014553207, 0.020836778, -0.022368807, -0.04392204, -0.017737128, 0.021430675, 0.013592231, 0.012731836, 0.0038867812, -0.03333643, -0.03177168, 0.018369831, -0.0044153817, 0.023774516, 0.0033385134, 0.009527718, 0.0032199968, -0.008123785, -0.010461502, -0.020104649, -0.010899571, 0.0036919126, -0.01505985, -0.035547256, 0.029195618, 0.00836193, -0.0031257174, -0.012548003, 0.008276347, -0.0062073655, 0.008377875, 0.0044152043, 0.009370235, -0.010262294, 0.026213396, -0.047776476, -0.0076019284, -0.046072166, 0.034080144, 0.04708474, 0.016887741, -0.009885441, 0.030334515, -0.017878516, 0.018351035, 0.024792878, -0.015724272, 0.008981331, -0.018996129, -0.01979231, 0.020773347, 0.0126279155, 0.0044938116, -0.01187637, -0.0005444625, 0.006843281, 0.023123201, 0.020533776, 0.024486467, -0.015983341, -0.026969647, 0.0023893982, 0.0315646, -0.02402019, 0.0054192157, 0.027887626, 0.0048745675, 0.024269693, -0.0074570943, -0.028718008, -0.0071378606, -0.0058130594, -0.0017354892, -0.42743066, -0.01868335, -0.02150815, -0.014938819, -0.018707903, -0.0062781246, -0.016588869, -0.016222054, 0.015956137, -0.0066683292, -0.0014411178, -0.021973483, 0.02273645, -0.021794233, 0.016480051, 0.006484712}
	exampleContent = "The dawn of Dark Mode"
)

func TestNewMilvusClient(t *testing.T) {
	milvusClient, err := NewMilvusClient("127.0.0.1:19530", defaultCollection)
	if err != nil {
		t.Fatal(err)
	}
	t.Logf("success new milvus client:%+v\n", milvusClient)
	//err = milvusClient.CreateIndex(context.Background(), defaultVectorColumn)
	//assert.Nil(t, err)
	//err = milvusClient.Insert(context.Background(), exampleContent, exampleVector)
	//assert.Nil(t, err)
	t.Logf("success insert new row")
	err = milvusClient.Search(context.Background(), defaultValueColumn, exampleVector)
	assert.Nil(t, err)
}

func TestMilvusDrop(t *testing.T) {
	milvusClient, err := NewMilvusClient("127.0.0.1:19530", defaultCollection)
	if err != nil {
		t.Fatal(err)
	}
	err = milvusClient.Client.DropCollection(context.Background(), defaultCollection)
	assert.Nil(t, err)
}
